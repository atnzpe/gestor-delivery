<!DOCTYPE html>
<html lang="pt-br">

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Card√°pio Digital Esquina do Zezo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    .hide-scroll::-webkit-scrollbar {
      display: none;
    }

    .hide-scroll {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #F9FAFB;
      -webkit-tap-highlight-color: transparent;
      padding-bottom: 80px;
    }

    .card-shadow {
      box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
    }

    .nav-item-active {
      background-color: #4F46E5;
      color: white;
      border-color: #4F46E5;
    }

    .nav-item-inactive {
      background-color: white;
      color: #374151;
      border-color: #E5E7EB;
    }

    .modal-enter {
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }

      to {
        transform: translateY(0);
      }
    }

    .scale-in {
      animation: scaleIn 0.4s ease-out forwards;
    }

    @keyframes scaleIn {
      from {
        transform: scale(0);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }
  </style>
</head>

<body class="text-gray-800">

  <header class="bg-white shadow-sm sticky top-0 z-40">
    <div class="max-w-3xl mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
          <span class="material-icons text-indigo-600">restaurant</span>
        </div>
        <div>
          <h1 class="text-lg font-bold leading-tight text-gray-900">Card√°pio Digital</h1>
          <p id="store-status" class="text-xs font-bold flex items-center gap-1 text-gray-400">
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></span> Verificando...
          </p>
        </div>
      </div>
      <button onclick="toggleSearch()" class="p-2 text-gray-500 hover:bg-gray-100 rounded-full">
         <span class="material-icons">search</span>
      </button>
    </div>
    <div id="search-bar" class="hidden px-4 pb-3 max-w-3xl mx-auto">
      <div class="relative">
        <input type="text" id="search" placeholder="Busca..." class="w-full pl-10 pr-4 py-2 bg-gray-100 border-none rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition" onkeyup="filterMenu()">
        <span class="material-icons absolute left-3 top-2.5 text-gray-400 text-lg">search</span>
      </div>
    </div>
    <div class="border-t border-gray-100 bg-white">
      <div id="category-nav" class="flex gap-2 overflow-x-auto hide-scroll px-4 py-3 max-w-3xl mx-auto snap-x">
        <div class="animate-pulse flex gap-2">
          <div class="h-8 w-24 bg-gray-200 rounded-full"></div>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 pt-4">
    <div id="loader-main" class="flex flex-col items-center justify-center py-20">
      <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
      <p class="text-gray-400 text-sm font-medium">Carregando...</p>
    </div>
    <div id="menu-container" class="space-y-8 pb-8 hidden"></div>
  </main>

  <div id="sticky-cart"
    class="fixed bottom-4 left-4 right-4 max-w-3xl mx-auto z-30 hidden transform transition-transform duration-300 translate-y-20">
    <button onclick="openCart()" class="w-full bg-indigo-600 text-white shadow-xl rounded-xl p-4 flex justify-between items-center active:scale-95 transition-transform">
        <div class="flex items-center gap-3">
           <div class="bg-indigo-800 w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold" id="cart-count">0</div>
           <span class="text-sm font-medium">Ver Sacola</span>
        </div>
        <div class="font-bold text-lg" id="cart-total-float">R$ 0,00</div>
     </button>
  </div>

  <div id="modal-product" class="fixed inset-0 z-50 hidden" aria-modal="true">
    <div class="fixed inset-0 bg-black bg-opacity-60 transition-opacity backdrop-blur-sm" onclick="closeProductModal()">
    </div>
    <div
      class="fixed inset-x-0 bottom-0 z-50 w-full max-w-lg mx-auto bg-white rounded-t-2xl sm:rounded-2xl sm:bottom-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 shadow-2xl h-[90vh] sm:h-auto sm:max-h-[90vh] flex flex-col modal-enter">
      <div class="relative h-48 sm:h-56 bg-gray-100 shrink-0">
        <img id="modal-prod-img" class="w-full h-full object-contain bg-white hidden" src="">
        <div id="modal-img-placeholder" class="w-full h-full flex items-center justify-center text-gray-300 bg-gray-50">
          <span class="material-icons text-6xl">image</span>
        </div>
        <button onclick="closeProductModal()" class="absolute top-4 right-4 bg-white bg-opacity-90 rounded-full p-2 text-gray-600 shadow-sm hover:bg-gray-100 transition"><span class="material-icons text-xl">close</span></button>
      </div>
      <div class="flex-1 overflow-y-auto p-5">
        <div class="mb-4">
          <h2 class="text-2xl font-bold text-gray-900 leading-tight mb-1" id="modal-prod-name"></h2>
          <div class="text-green-600 font-bold text-xl mb-2" id="modal-prod-price"></div>
          <p class="text-gray-500 text-sm leading-relaxed" id="modal-prod-desc"></p>
        </div>
        <div id="modal-addons-area" class="border-t border-gray-100 pt-4 hidden">
          <h3 class="font-bold text-gray-800 mb-3 text-sm uppercase tracking-wider">Adicionais</h3>
          <div id="modal-addons-list" class="space-y-3"></div>
        </div>
        <div class="mt-6">
          <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-1"><span class="material-icons text-sm text-gray-400">edit_note</span> Observa√ß√£o</label>
          <textarea id="modal-obs" rows="2" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none resize-none" placeholder="Ex: Tirar a cebola..."></textarea>
        </div>
      </div>
      <div class="p-4 border-t border-gray-100 bg-white safe-area-bottom">
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center border border-gray-200 rounded-xl px-2 h-12">
            <button onclick="changeModalQty(-1)" class="w-10 h-full text-indigo-600 text-xl font-bold">-</button>
            <span id="modal-qty" class="w-8 text-center font-bold text-gray-800">1</span>
            <button onclick="changeModalQty(1)" class="w-10 h-full text-indigo-600 text-xl font-bold">+</button>
          </div>
          <button onclick="confirmAddCart()" class="flex-1 h-12 bg-indigo-600 text-white rounded-xl font-bold shadow-lg flex justify-between items-center px-5 active:scale-95 transition"><span>Adicionar</span><span id="modal-btn-total"></span></button>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-cart" class="fixed inset-0 z-50 hidden bg-white sm:bg-gray-900 sm:bg-opacity-50 flex justify-end">
    <div class="w-full sm:max-w-md bg-white h-full flex flex-col shadow-2xl modal-enter">
      <header class="p-4 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
        <div class="flex items-center gap-3">
          <button onclick="closeCart()" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded-full"><span class="material-icons">arrow_back</span></button>
          <h2 class="font-bold text-lg">Sua Sacola</h2>
        </div>
        <button onclick="clearCart()" class="text-xs font-bold text-red-500 uppercase hover:underline">Limpar</button>
      </header>
      <div class="flex-1 overflow-y-auto p-4 bg-gray-50">
        <div id="cart-items-list" class="space-y-3"></div>
        <div class="mt-6 bg-white p-5 rounded-xl shadow-sm border border-gray-100">
          <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span class="material-icons text-indigo-500">place</span> Entrega
          </h3>
          <div class="space-y-3">
            <div><label class="text-xs font-bold text-gray-400 uppercase">Seu Nome</label><input id="cli-nome" class="w-full border-b-2 border-gray-200 focus:border-indigo-500 bg-transparent py-2 outline-none font-medium">
            </div>
            <div><label class="text-xs font-bold text-gray-400 uppercase">WhatsApp</label><input id="cli-tel" type="tel" class="w-full border-b-2 border-gray-200 focus:border-indigo-500 bg-transparent py-2 outline-none font-medium" placeholder="(xx) 9xxxx-xxxx">
            </div>
            <div class="grid grid-cols-3 gap-4">
              <div class="col-span-2"><label class="text-xs font-bold text-gray-400 uppercase">Rua</label><input id="cli-rua" class="w-full border-b-2 border-gray-200 focus:border-indigo-500 bg-transparent py-2 outline-none text-sm">
              </div>
              <div><label class="text-xs font-bold text-gray-400 uppercase">N¬∫</label><input id="cli-num" class="w-full border-b-2 border-gray-200 focus:border-indigo-500 bg-transparent py-2 outline-none text-sm">
              </div>
            </div>
            <div>
              <label class="text-xs font-bold text-gray-400 uppercase">Bairro</label><select id="select-bairro" onchange="atualizarTaxaEntrega()" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 mt-1 text-sm outline-none focus:ring-2 focus:ring-indigo-500"><option value="" disabled selected>Selecione...</option></select><input type="hidden" id="input-taxa-valor" value="0">
            </div>
            <div><label class="text-xs font-bold text-gray-400 uppercase">Ref.</label><input id="cli-ref" class="w-full border-b-2 border-gray-200 focus:border-indigo-500 bg-transparent py-2 outline-none text-sm">
            </div>
            <div class="pt-2">
              <label class="text-xs font-bold text-gray-400 uppercase">Pagamento</label><select id="cli-pag" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 mt-1 text-sm outline-none focus:ring-2 focus:ring-indigo-500"></select>
            </div>
          </div>
        </div>
      </div>
      <div class="p-5 bg-white border-t border-gray-100 shadow-lg z-20">
        <div class="space-y-2 mb-4 text-sm">
          <div class="flex justify-between text-gray-500"><span>Subtotal</span>
            <span id="cart-subtotal-price">R$ 0,00</span>
          </div>
          <div class="flex justify-between text-gray-500"><span>Entrega</span>
            <span id="taxa-entrega" class="text-indigo-600 font-bold">R$ 0,00</span>
          </div>
          <div class="flex justify-between text-xl font-bold text-gray-900 pt-2 border-t border-dashed">
            <span>Total</span> <span id="cart-total-price">R$ 0,00</span>
          </div>
        </div>
        <button onclick="submitOrder()" id="btn-submit" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition hover:bg-green-700 flex justify-center items-center gap-2"><span>Confirmar Pedido</span> <span class="material-icons text-sm">check</span></button>
        <p id="msg-error" class="text-red-500 text-xs font-bold text-center mt-2 hidden"></p>
      </div>
    </div>
  </div>

  <div id="modal-success"
    class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black bg-opacity-80 backdrop-blur-sm">
    <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-8 text-center scale-in relative">
      <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <span class="material-icons text-5xl text-green-600">whatsapp</span>
      </div>
      <h2 class="text-2xl font-black text-gray-900 mb-2">Redirecionando...</h2>
      <p class="text-gray-500 mb-6 text-sm">Seu pedido <strong id="success-id" class="text-indigo-600">...</strong> foi
        salvo!</p>

      <p class="text-xs text-gray-400 mb-4">Se o WhatsApp n√£o abrir, clique abaixo:</p>

      <a id="btn-whatsapp" href="#" target="_blank"
        class="block w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:scale-105 flex items-center justify-center gap-2 mb-3">
        <span class="text-2xl">üì±</span> Abrir WhatsApp Agora
      </a>
      <button onclick="resetApp()" class="text-gray-400 text-xs font-bold uppercase tracking-wide hover:text-gray-600 transition">
            Fechar e Iniciar Novo
        </button>
    </div>
  </div>

  <script>
    // Vari√°vel global
    let lojaAberta = true; // Assume aberto por padr√£o para evitar bloqueio indevido em falha de rede
    let checkInterval = null;

    

    function checkOpenStatus() {
       const el = document.getElementById('store-status');
       const btn = document.getElementById('btn-submit');
       
       google.script.run
         .withSuccessHandler(res => {
            lojaAberta = res.aberto;
            
            // Limpa classes anteriores
            el.className = "text-xs font-bold flex items-center gap-1 transition-colors duration-300";
            
            if (res.aberto) {
               // ABERTO
               el.classList.add("text-green-600");
               el.innerHTML = `<span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> ${res.mensagem || 'Aberto agora'}`;
               
               if(btn) {
                   btn.disabled = false;
                   btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                   btn.classList.add('bg-green-600', 'hover:bg-green-700');
                   btn.innerHTML = '<span>Confirmar Pedido</span> <span class="material-icons text-sm">check</span>';
               }

            } else {
               // FECHADO
               el.classList.add("text-red-600");
               el.innerHTML = `<span class="w-2 h-2 bg-red-500 rounded-full"></span> ${res.mensagem || 'Fechado'}`;
               
               if(btn) { 
                  btn.disabled = true; 
                  btn.classList.remove('bg-green-600', 'hover:bg-green-700'); 
                  btn.classList.add('bg-gray-400', 'cursor-not-allowed'); 
                  btn.innerHTML = `<span class="material-icons text-sm">lock</span> LOJA FECHADA`;
               }
            }
         })
         .withFailureHandler(err => {
            console.error("Erro ao verificar status:", err);
            // Em caso de erro, mant√©m o √∫ltimo estado conhecido ou 'Verificando...'
         })
         .verificarStatusLoja();
    }    

    let menuData = {}, cart = [], currentProduct = null, modalQty = 1, totalProducts = 0;

    // --- INIT ---
    window.onload = () => {
       // 1. Carrega dados est√°ticos primeiro (R√°pido)
       google.script.run.withSuccessHandler(renderMenu).getCardapioParaDelivery();
       google.script.run.withSuccessHandler(populateBairros).getBairrosParaDelivery();
       google.script.run.withSuccessHandler(populatePagamentos).getPagamentosParaDelivery();
       
       // 2. Verifica status da loja (Ass√≠ncrono)
       checkOpenStatus();
       
       // 3. Revalida a cada 60 segundos (opcional, para atualizar sem F5)
       checkInterval = setInterval(checkOpenStatus, 60000);
    };

    

    function toggleSearch() {
       document.getElementById('search-bar').classList.toggle('hidden');
       document.getElementById('search').focus();
    }

    function populateBairros(list) {
       const sel = document.getElementById('select-bairro');
       sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
       list.forEach(b => {
          const opt = document.createElement('option');
          opt.value = b.bairro; opt.textContent = `${b.bairro} (+R$ ${b.taxa.toFixed(2)})`; opt.dataset.taxa = b.taxa;
          sel.appendChild(opt);
       });
       const opt = document.createElement('option'); opt.value = "Outro"; opt.textContent = "Outro (A Combinar)"; opt.dataset.taxa = 0; sel.appendChild(opt);
    }

    function populatePagamentos(list) {
       const sel = document.getElementById('cli-pag');
       sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
       list.forEach(p => { const o=document.createElement('option'); o.value=p; o.textContent=p; sel.appendChild(o); });
    }

    function atualizarTaxaEntrega() {
       const sel = document.getElementById('select-bairro');
       const opt = sel.options[sel.selectedIndex];
       const taxa = opt ? parseFloat(opt.dataset.taxa || 0) : 0;
       document.getElementById('input-taxa-valor').value = taxa;
       document.getElementById('taxa-entrega').textContent = taxa > 0 ? `R$ ${taxa.toFixed(2)}` : 'A combinar';
       document.getElementById('cart-total-price').textContent = `R$ ${(totalProducts + taxa).toFixed(2)}`;
    }

    function renderMenu(data) {
       menuData = data;
       document.getElementById('loader-main').classList.add('hidden');
       const container = document.getElementById('menu-container');
       const nav = document.getElementById('category-nav');
       container.innerHTML = ''; nav.innerHTML = ''; container.classList.remove('hidden');

       let first = true;
       for(const [cat, items] of Object.entries(data)) {
          if(items.length === 0) continue;
          const pill = document.createElement('button');
          pill.className = `whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-bold border transition ${first ? 'nav-item-active' : 'nav-item-inactive'}`;
          pill.textContent = cat;
          pill.onclick = () => document.getElementById('cat-'+cat).scrollIntoView({behavior:'smooth', block:'start'});
          nav.appendChild(pill);
          first = false;

          const sec = document.createElement('div');
          sec.id = 'cat-'+cat; sec.className = 'scroll-mt-32 fade-in';
          sec.innerHTML = `<h2 class="text-xl font-bold text-gray-800 mb-4">${cat}</h2>`;
          const grid = document.createElement('div'); grid.className = 'grid gap-4';

          items.forEach(item => {
             const card = document.createElement('div');
             card.className = 'bg-white p-4 rounded-2xl card-shadow flex gap-4 cursor-pointer active:bg-gray-50 transition';
             card.onclick = () => openProductModal(item);
             const imgHtml = item.foto_url ? `<img src="${item.foto_url}" class="w-24 h-24 object-cover rounded-xl bg-gray-100 shrink-0">` : '';
             card.innerHTML = `${imgHtml}<div class="flex-1 flex flex-col justify-between"><div><h3 class="font-bold text-gray-900 leading-tight mb-1">${item.nome}</h3><p class="text-xs text-gray-500 line-clamp-2">${item.descricao||''}</p></div><div class="flex justify-between items-end mt-2"><span class="text-green-600 font-bold">R$ ${item.preco.toFixed(2)}</span><button class="bg-gray-100 text-indigo-600 p-1.5 rounded-lg"><span class="material-icons text-sm">add</span></button></div></div>`;
             grid.appendChild(card);
          });
          sec.appendChild(grid); container.appendChild(sec);
       }
    }

    function filterMenu() {
       const term = document.getElementById('search').value.toLowerCase();
       for(let sec of document.getElementById('menu-container').children) {
          let hasVis = false;
          sec.querySelectorAll('.grid > div').forEach(item => {
             if(item.innerText.toLowerCase().includes(term)) { item.style.display = 'flex'; hasVis = true; } else item.style.display = 'none';
          });
          sec.style.display = hasVis ? 'block' : 'none';
       }
    }

    function openProductModal(item) {
       currentProduct = item; modalQty = 1;
       document.getElementById('modal-prod-name').textContent = item.nome;
       document.getElementById('modal-prod-desc').textContent = item.descricao || '';
       document.getElementById('modal-prod-price').textContent = `R$ ${item.preco.toFixed(2)}`;
       document.getElementById('modal-obs').value = '';
       
       const img = document.getElementById('modal-prod-img');
       const ph = document.getElementById('modal-img-placeholder');
       if(item.foto_url) { img.src = item.foto_url; img.classList.remove('hidden'); ph.classList.add('hidden'); } 
       else { img.classList.add('hidden'); ph.classList.remove('hidden'); }

       const lst = document.getElementById('modal-addons-list');
       const area = document.getElementById('modal-addons-area');
       lst.innerHTML = '';
       if(item.adicionaisPermitidos && item.adicionaisPermitidos.length > 0) {
          area.classList.remove('hidden');
          item.adicionaisPermitidos.forEach(add => {
             lst.innerHTML += `<label class="flex justify-between items-center p-3 border border-gray-100 rounded-xl cursor-pointer hover:bg-gray-50"><div class="flex items-center gap-3"><input type="checkbox" value="${add.id}" data-price="${add.preco}" data-name="${add.nome}" class="addon-check w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500" onchange="calcModalTotal()"><span class="text-sm font-medium text-gray-700">${add.nome}</span></div><span class="text-sm font-bold text-green-600">+ R$ ${add.preco.toFixed(2)}</span></label>`;
          });
       } else area.classList.add('hidden');

       calcModalTotal();
       document.getElementById('modal-qty').textContent = '1';
       document.getElementById('modal-product').classList.remove('hidden');
    }

    function closeProductModal() { document.getElementById('modal-product').classList.add('hidden'); }
    function changeModalQty(d) { modalQty += d; if(modalQty < 1) modalQty = 1; document.getElementById('modal-qty').textContent = modalQty; calcModalTotal(); }

    function calcModalTotal() {
       let tot = currentProduct.preco;
       document.querySelectorAll('.addon-check:checked').forEach(c => tot += parseFloat(c.dataset.price));
       tot *= modalQty;
       document.getElementById('modal-btn-total').textContent = `R$ ${tot.toFixed(2)}`;
    }

    function confirmAddCart() {
       const adds = []; let addsTotal = 0;
       document.querySelectorAll('.addon-check:checked').forEach(c => {
          const p = parseFloat(c.dataset.price);
          adds.push({ id: c.value, nome: c.dataset.name, preco: p });
          addsTotal += p;
       });
       cart.push({
          id: currentProduct.id, nome: currentProduct.nome, precoBase: currentProduct.preco,
          qtde: modalQty, adicionais: adds, obs: document.getElementById('modal-obs').value,
          unitTotal: currentProduct.preco + addsTotal
       });
       closeProductModal(); updateCartFloat();
    }

    function updateCartFloat() {
       const float = document.getElementById('sticky-cart');
       if(cart.length > 0) { float.classList.remove('hidden', 'translate-y-20'); float.classList.add('translate-y-0'); } 
       else float.classList.add('translate-y-20');
       
       const qtd = cart.reduce((a,b)=>a+b.qtde,0);
       totalProducts = cart.reduce((a,b)=>a+(b.unitTotal*b.qtde),0);
       document.getElementById('cart-count').textContent = qtd;
       document.getElementById('cart-total-float').textContent = `R$ ${totalProducts.toFixed(2)}`;
    }

    function openCart() {
       const list = document.getElementById('cart-items-list'); list.innerHTML = '';
       cart.forEach((item, idx) => {
          const sub = item.unitTotal * item.qtde;
          const addsTxt = item.adicionais.map(a=>`+ ${a.nome}`).join(', ');
          list.innerHTML += `<div class="bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-start"><div><div class="font-bold text-gray-800 flex items-center gap-2"><span class="bg-indigo-100 text-indigo-700 w-6 h-6 rounded flex items-center justify-center text-xs">${item.qtde}</span>${item.nome}</div><div class="text-xs text-gray-500 mt-1 ml-8">${addsTxt}</div>${item.obs ? `<div class="text-xs text-orange-500 ml-8 font-medium">Obs: ${item.obs}</div>` : ''}<div class="text-green-600 font-bold ml-8 mt-1">R$ ${sub.toFixed(2)}</div></div><button onclick="remItem(${idx})" class="text-red-400 p-1 hover:bg-red-50 rounded"><span class="material-icons text-sm">delete</span></button></div>`;
       });
       document.getElementById('cart-subtotal-price').textContent = `R$ ${totalProducts.toFixed(2)}`;
       atualizarTaxaEntrega();
       document.getElementById('modal-cart').classList.remove('hidden');
    }

    function closeCart() { document.getElementById('modal-cart').classList.add('hidden'); }
    function remItem(i) { cart.splice(i,1); updateCartFloat(); openCart(); if(cart.length===0) closeCart(); }
    function clearCart() { if(confirm('Esvaziar?')) { cart=[]; updateCartFloat(); closeCart(); }}

    function submitOrder() {
       if(!lojaAberta) { alert("A loja est√° fechada no momento."); return; } 
       const btn = document.getElementById('btn-submit');
       const msg = document.getElementById('msg-error');
       
       const nome = document.getElementById('cli-nome').value.trim();
       const tel = document.getElementById('cli-tel').value.replace(/\D/g,'');
       const rua = document.getElementById('cli-rua').value.trim();
       const num = document.getElementById('cli-num').value.trim();
       const bairro = document.getElementById('select-bairro').value;
       const pag = document.getElementById('cli-pag').value;

       if(nome.length < 3 || tel.length < 10 || rua==='' || num==='' || bairro==='' || pag==='') {
          alert('Por favor, preencha todos os dados de entrega e pagamento.');
          return;
       }

       btn.disabled = true; btn.innerHTML = '<span class="animate-spin material-icons">refresh</span> Enviando...';
       
       const pedido = {
          itens: cart,
          clienteNome: nome,
          clienteTelefone: tel,
          logradouro: rua,
          numero: num,
          bairro: bairro,
          referencia: document.getElementById('cli-ref').value,
          pagamento: pag
       };

       google.script.run
         .withSuccessHandler(res => {
            if(res.status === 'sucesso') {
               // SUCESSO: Limpa carrinho e prepara modal
               cart=[]; updateCartFloat(); closeCart();
               
               const modalSuccess = document.getElementById('modal-success');
               document.getElementById('success-id').textContent = '#' + (res.idVenda.split('-')[1] || res.idVenda);
               document.getElementById('btn-whatsapp').href = res.mensagemWhatsApp;
               modalSuccess.classList.remove('hidden');
               
               // --- CORRE√á√ÉO AQUI ---
               // Usa window.open com '_blank' para for√ßar NOVA ABA e evitar erro de iframe
               setTimeout(() => { 
                   window.open(res.mensagemWhatsApp, '_blank'); 
               }, 1000);
               
            } else {
               msg.textContent = 'Erro: '+res.message; msg.classList.remove('hidden'); btn.disabled=false; btn.textContent='Tentar Novamente';
            }
         })
         .withFailureHandler(e => { alert(e.message); btn.disabled=false; })
         .processarPedidoDelivery(JSON.stringify(pedido));
    }

    // --- FUN√á√ÉO DE RESET (SOFT RELOAD) ---
    function resetApp() {
       // 1. Esconde o modal de sucesso
       document.getElementById('modal-success').classList.add('hidden');
       
       // 2. Limpa os campos de input para n√£o irem dados antigos
       document.getElementById('cli-nome').value = '';
       document.getElementById('cli-tel').value = '';
       document.getElementById('cli-rua').value = '';
       document.getElementById('cli-num').value = '';
       document.getElementById('cli-ref').value = '';
       
       // 3. Reseta os selects para a primeira op√ß√£o
       const selBairro = document.getElementById('select-bairro');
       if(selBairro.options.length > 0) selBairro.selectedIndex = 0;
       
       const selPag = document.getElementById('cli-pag');
       if(selPag.options.length > 0) selPag.selectedIndex = 0;

       // 4. Garante que o carrinho visual sumiu (j√° foi limpo no submit)
       updateCartFloat();
       
       // 5. Rola a p√°gina para o topo
       window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  </script>
</body>

</html>