
<!DOCTYPE html>
<html lang="pt-br">

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Monitor KDS | Gestor Delivery</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* CONFIGURA√á√ïES GERAIS DE UX */
    body {
      background-color: #111827;
      /* Fundo mais escuro para contraste (Dark Mode) */
      color: #f3f4f6;
      font-family: 'Inter', system-ui, sans-serif;
      -webkit-tap-highlight-color: transparent;
      /* Remove flash azul no toque mobile */
    }

    /* SCROLLBAR PERSONALIZADA (Mais discreta) */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1f2937;
    }

    ::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #6b7280;
    }

    /* STATUS COLORS (Refinadas para acessibilidade visual) */
    .status-border-NOVO {
      border-left: 6px solid #ef4444;
    }

    .status-bg-NOVO {
      background-color: #ef4444;
    }

    .status-border-PREPARANDO {
      border-left: 6px solid #f59e0b;
    }

    .status-bg-PREPARANDO {
      background-color: #f59e0b;
    }

    .status-border-EMBALAGEM {
      border-left: 6px solid #3b82f6;
    }

    .status-bg-EMBALAGEM {
      background-color: #3b82f6;
    }

    .status-border-PRONTO_ENTREGA {
      border-left: 6px solid #10b981;
    }

    .status-bg-PRONTO_ENTREGA {
      background-color: #10b981;
    }

    .status-border-SAIU_ENTREGA {
      border-left: 6px solid #8b5cf6;
    }

    .status-bg-SAIU_ENTREGA {
      background-color: #8b5cf6;
    }

    .status-border-ENTREGUE {
      border-left: 6px solid #6b7280;
    }

    .status-bg-ENTREGUE {
      background-color: #6b7280;
    }

    /* ANIMA√á√ïES DE INTERFACE */
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    }

    .btn-active:active {
      transform: scale(0.96);
    }

    .blink-animation {
      animation: blinker 1.5s linear infinite;
    }

    @keyframes blinker {
      50% {
        opacity: 0.6;
      }
    }

    /* MODAL TRANSITIONS */
    .modal-enter {
      opacity: 0;
      transform: scale(0.95);
    }

    .modal-enter-active {
      opacity: 1;
      transform: scale(1);
      transition: all 0.2s ease-out;
    }

    .modal-exit {
      opacity: 0;
      transform: scale(0.95);
      transition: all 0.2s ease-in;
    }

    /* --- CSS DE IMPRESS√ÉO OTIMIZADO (Mantido do seu V2.2) --- */
    @media print {
      @page {
        margin: 0;
        size: auto;
      }

      body {
        background-color: white !important;
        color: #000000 !important;
        font-family: 'Courier New', Courier, monospace;
        display: block;
        /* Reseta flex do body */
      }

      #app-screen,
      #login-screen,
      #modal,
      #modal-filtro {
        display: none !important;
      }

      #printable-area {
        display: block !important;
        width: 80mm;
        margin: 0 auto;
        padding: 5px 0;
        font-size: 12px;
        font-weight: 600;
        line-height: 1.2;
      }

      /* Classes utilit√°rias de impress√£o */
      .dashed-line {
        border-bottom: 1px dashed #000;
        margin: 5px 0;
      }

      .solid-line {
        border-bottom: 2px solid #000;
        margin: 5px 0;
      }

      .txt-center {
        text-align: center;
      }

      .txt-right {
        text-align: right;
      }

      .txt-huge {
        font-size: 20px;
        font-weight: 900;
      }

      .txt-big {
        font-size: 14px;
        font-weight: 800;
      }

      .txt-small {
        font-size: 10px;
      }

      .item-row {
        display: flex;
        justify-content: space-between;
      }
    }
  </style>
</head>

<body class="h-screen flex flex-col overflow-hidden selection:bg-orange-500 selection:text-white">

  <div id="printable-area" style="display: none;"></div>

  <div id="login-screen" class="fixed inset-0 bg-gray-900 z-[100] flex items-center justify-center p-4">
    <div class="bg-white text-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm transform transition-all">
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-20 h-20 bg-orange-100 rounded-full mb-4">
          <span class="material-icons text-5xl text-orange-600">restaurant</span>
        </div>
        <h2 class="text-3xl font-extrabold text-gray-900">KDS Cozinha</h2>
        <p class="text-gray-500 text-sm mt-1">Entre com suas credenciais</p>
      </div>

      <form id="login-form" class="space-y-5">
        <div>
          <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Usu√°rio</label>
          <input type="text" id="user-login" class="w-full border border-gray-300 bg-gray-50 p-3 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none transition" required>
        </div>
        <div>
          <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Senha</label>
          <input type="password" id="user-pass" class="w-full border border-gray-300 bg-gray-50 p-3 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none transition" required>
        </div>
        <button type="submit" class="w-full bg-orange-600 text-white font-bold py-3.5 rounded-xl hover:bg-orange-700 shadow-lg transition transform active:scale-95">
          ACESSAR SISTEMA
        </button>
      </form>
      <p id="login-msg" class="text-center text-red-500 text-sm mt-4 font-bold min-h-[20px]"></p>
    </div>
  </div>

  <div id="app-screen" class="flex-1 flex flex-col hidden h-full relative">

    <header class="bg-gray-800 border-b border-gray-700 shadow-lg z-30 sticky top-0">
      <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">

          <div class="flex items-center gap-3 overflow-hidden">
            <span class="material-icons text-orange-500 text-3xl hidden sm:block">soup_kitchen</span>
            <div class="flex flex-col">
              <h1 class="text-lg sm:text-xl font-bold tracking-tight text-white truncate">Monitor KDS</h1>
              <div class="flex items-center text-xs text-gray-400 gap-2">
                <span id="user-display" class="text-green-400 font-bold truncate max-w-[100px]"></span>
                <span class="hidden sm:inline">|</span>
                <span id="last-update" class="truncate">...</span>
              </div>
            </div>
          </div>

          <div class="flex items-center gap-2 sm:gap-3">
            <button onclick="abrirFiltro()" class="p-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-gray-200 transition btn-active" title="Filtros">
               <span class="material-icons">filter_list</span>
            </button>

            <select id="filtro-status" class="bg-gray-700 text-white text-sm font-medium p-2 rounded-lg border-none focus:ring-2 focus:ring-orange-500 outline-none cursor-pointer" onchange="renderCards()">
              <option value="TODOS">Todos</option>
              <option value="NOVO">üî• Novos</option>
              <option value="PROCESSO">üç≥ Produ√ß√£o</option>
            </select>

            <button onclick="loadPedidos()" class="p-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white shadow-md transition btn-active" title="Atualizar">
               <span class="material-icons">refresh</span>
            </button>

            <button onclick="logout()" class="p-2 rounded-lg bg-red-600 hover:bg-red-500 text-white shadow-md transition btn-active" title="Sair">
               <span class="material-icons">logout</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <div class="flex-1 overflow-y-auto bg-gray-900 p-3 sm:p-5">
      <div id="board" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20">
      </div>
    </div>
  </div>

  <div id="modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900 bg-opacity-90 transition-opacity backdrop-blur-sm" onclick="closeModal()">
    </div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-0 sm:items-center sm:p-4 text-center">

        <div
          class="relative transform overflow-hidden rounded-t-2xl sm:rounded-2xl bg-white text-left shadow-xl transition-all w-full sm:max-w-2xl flex flex-col max-h-[90vh]">

          <div class="bg-gray-50 px-4 py-3 sm:px-6 border-b border-gray-200 flex justify-between items-center shrink-0">
            <div class="flex items-center gap-3">
              <h3 class="text-2xl font-black text-gray-900" id="modal-id">#ID</h3>
              <button onclick="imprimirCupom()" class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-bold rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none btn-active">
                  <span class="material-icons text-sm mr-1">print</span> CUPOM
               </button>
            </div>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-500 btn-active focus:outline-none">
               <span class="material-icons text-2xl">close</span>
            </button>
          </div>

          <div class="px-4 py-4 sm:p-6 overflow-y-auto flex-1 bg-white">

            <div id="modal-info" class="bg-blue-50 rounded-lg p-3 mb-4 border border-blue-100"></div>

            <div id="modal-obs-geral-container" class="hidden mb-4">
              <div class="bg-red-50 border-l-4 border-red-500 p-3 rounded-r">
                <p class="text-xs font-bold text-red-500 uppercase mb-1">OBSERVA√á√ÉO DO PEDIDO</p>
                <p class="text-red-700 font-bold text-sm" id="modal-obs-geral">-</p>
              </div>
            </div>

            <div class="hidden">
              <p id="modal-cliente"></p>
              <p id="modal-tel"></p>
              <p id="modal-endereco"></p><span id="modal-pagamento"></span>
            </div>

            <div class="mb-6">
              <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Itens do Pedido</h4>
              <div id="modal-itens" class="space-y-3"></div>
            </div>

            <div class="border-t pt-4">
              <div onclick="toggleHistory()" class="flex items-center justify-between cursor-pointer group">
                <h4
                  class="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-1 group-hover:text-gray-600">
                  <span class="material-icons text-sm">history</span> Hist√≥rico de A√ß√µes
                </h4>
                <span class="material-icons text-gray-400 text-sm">expand_more</span>
              </div>
              <div id="modal-history" class="mt-2 space-y-2 text-xs text-gray-600 hidden"></div>
            </div>
          </div>

          <div class="bg-gray-50 px-4 py-3 sm:px-6 border-t border-gray-200 shrink-0">
            <div class="grid grid-cols-5 gap-2 sm:gap-3" id="status-actions">
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div id="modal-filtro" class="fixed inset-0 z-[60] hidden" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900 bg-opacity-90 backdrop-blur-sm transition-opacity"
      onclick="document.getElementById('modal-filtro').classList.add('hidden')"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
      <div class="flex min-h-full items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden transform transition-all">
          <div class="bg-indigo-600 px-4 py-3 flex justify-between items-center">
            <h3 class="text-white font-bold flex items-center gap-2"><span class="material-icons">filter_alt</span>
              Filtros Avan√ßados</h3>
            <button onclick="document.getElementById('modal-filtro').classList.add('hidden')" class="text-indigo-200 hover:text-white"><span class="material-icons">close</span></button>
          </div>
          <div class="p-6 space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div><label class="text-xs font-bold text-gray-500 mb-1 block">Data In√≠cio</label><input type="date" id="f-dt-ini" class="w-full border-gray-300 rounded-lg text-sm">
              </div>
              <div><label class="text-xs font-bold text-gray-500 mb-1 block">Data Fim</label><input type="date" id="f-dt-fim" class="w-full border-gray-300 rounded-lg text-sm">
              </div>
            </div>
            <div><label class="text-xs font-bold text-gray-500 mb-1 block">Busca R√°pida</label><input id="f-termo" type="text" placeholder="Nome, Telefone ou ID..." class="w-full border-gray-300 rounded-lg text-sm p-2.5">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div><label class="text-xs font-bold text-gray-500 mb-1 block">Bairro</label><input id="f-bairro" class="w-full border-gray-300 rounded-lg text-sm">
              </div>
              <div><label class="text-xs font-bold text-gray-500 mb-1 block">Produto</label><input id="f-prod" class="w-full border-gray-300 rounded-lg text-sm">
              </div>
            </div>
            <div>
              <label class="text-xs font-bold text-gray-500 mb-1 block">Status</label>
              <select id="f-status" class="w-full border-gray-300 rounded-lg text-sm p-2.5 bg-white">
                       <option value="">Todos</option><option value="NOVO">Novo</option><option value="ENTREGUE">Entregue</option><option value="CANCELADO">Cancelado</option>
                    </select>
            </div>
            <button onclick="aplicarFiltros()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 shadow-lg btn-active flex justify-center items-center gap-2 mt-2">
                    <span class="material-icons">search</span> APLICAR FILTROS
                 </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ESTADO GLOBAL
    let currentUser = null;
    let todosPedidos = [];
    let autoRefresh;
    let pedidoAtual = null;

    // INIT
    window.onload = () => { checkSession(); };

    // --- AUTH SYSTEM ---
    function checkSession() {
       const stored = localStorage.getItem('kds_user');
       if (stored) { currentUser = JSON.parse(stored); showKDS(); } else { showLogin(); }
    }
    function showLogin() { 
       document.getElementById('login-screen').classList.remove('hidden'); 
       document.getElementById('app-screen').classList.add('hidden'); 
    }
    function showKDS() {
       document.getElementById('login-screen').classList.add('hidden');
       document.getElementById('app-screen').classList.remove('hidden');
       document.getElementById('user-display').textContent = currentUser.nome.split(' ')[0]; // S√≥ o primeiro nome
       renderCards(); loadPedidos(); 
       if(autoRefresh) clearInterval(autoRefresh);
       autoRefresh = setInterval(loadPedidos, 30000); 
    }
    function logout() { localStorage.removeItem('kds_user'); location.reload(); }

    document.getElementById('login-form').addEventListener('submit', (e) => {
       e.preventDefault();
       const u = document.getElementById('user-login').value;
       const p = document.getElementById('user-pass').value;
       const btn = e.target.querySelector('button');
       const msg = document.getElementById('login-msg');
       btn.disabled = true; btn.innerHTML = '<span class="material-icons animate-spin">refresh</span> Verificando...';
       msg.textContent = '';

       google.script.run.withSuccessHandler(res => {
            localStorage.setItem('kds_user', JSON.stringify(res.usuario));
            currentUser = res.usuario; showKDS();
       }).withFailureHandler(err => { 
            btn.disabled=false; btn.textContent='ENTRAR'; msg.textContent=err.message; 
       }).autenticarUsuario(u, p);
    });

    // --- CORE KDS ---
    function forceRefresh() { 
       const el = document.getElementById('last-update');
       el.innerHTML = '<span class="material-icons animate-spin text-xs">refresh</span>';
       loadPedidos(); 
    }
    
    function loadPedidos() {
      google.script.run.withSuccessHandler(data => {
          todosPedidos = data || [];
          document.getElementById('last-update').textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          renderCards();
      }).getPedidosCozinha();
    }

    function renderCards() {
      const board = document.getElementById('board');
      const filtro = document.getElementById('filtro-status').value;
      board.innerHTML = '';
      
      if (!todosPedidos.length) { 
         board.innerHTML = `
            <div class="col-span-full flex flex-col items-center justify-center text-gray-500 mt-20">
               <span class="material-icons text-6xl mb-4 text-gray-700">inbox</span>
               <p class="text-lg">Nenhum pedido na fila.</p>
            </div>`; 
         return; 
      }

      let filtrados = todosPedidos;
      // Filtros de abas r√°pidas
      if (filtro === 'NOVO') filtrados = todosPedidos.filter(p => p.status === 'NOVO');
      else if (filtro === 'PROCESSO') filtrados = todosPedidos.filter(p => ['PREPARANDO', 'EMBALAGEM', 'PRONTO_ENTREGA', 'SAIU_ENTREGA'].includes(p.status));

      filtrados.forEach(p => {
        const dt = new Date(p.dataHora);
        const time = isNaN(dt) ? '--:--' : `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
        const total = parseFloat(p.total||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        
        // Badge Motoqueiro
        let motoHtml = '';
        if(p.nomeMotoqueiro && (p.status==='SAIU_ENTREGA'||p.status==='ENTREGUE')) {
            motoHtml = `<div class="mt-3 bg-gray-800 bg-opacity-50 border border-gray-600 p-1.5 rounded text-xs text-yellow-400 font-bold flex items-center gap-1 justify-center">
               <span class="material-icons text-sm">two_wheeler</span> ${p.nomeMotoqueiro.split(' ')[0]}
            </div>`;
        }

        // Card DCU
        const div = document.createElement('div');
        // Classes din√¢micas para borda colorida
        div.className = `bg-gray-800 rounded-xl shadow-lg p-4 cursor-pointer relative overflow-hidden transition-all card-hover status-border-${p.status||'NOVO'}`;
        div.onclick = () => openModal(p);
        
        const isNovo = p.status === 'NOVO';
        const animation = isNovo ? 'animate-pulse' : '';

        div.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div class="flex flex-col">
               <span class="font-black text-2xl text-white tracking-tighter">#${p.id.split('-')[1]||p.id}</span>
               <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">${p.status.replace('_', ' ')}</span>
            </div>
            <span class="text-xs font-bold bg-gray-700 px-2 py-1 rounded-md text-gray-300 border border-gray-600 ${animation}">${time}</span>
          </div>
          
          <div class="font-bold text-lg text-gray-100 truncate mb-1">${p.clienteNome}</div>
          
          <div class="flex justify-between items-end mt-2">
             <div class="flex flex-col text-sm text-gray-400">
                <span class="flex items-center gap-1 truncate max-w-[120px]"><span class="material-icons text-xs">place</span> ${p.bairro}</span>
             </div>
             <div class="text-green-400 font-bold text-lg">${total}</div>
          </div>
          
          ${motoHtml}
        `;
        board.appendChild(div);
      });
    }

    // --- MODAL ---
    function openModal(pedido) {
      pedidoAtual = pedido;
      document.getElementById('modal-id').textContent = '#' + (pedido.id.split('-')[1] || pedido.id);
      
      // Header Info
      document.getElementById('modal-info').innerHTML = `
         <div class="flex justify-between items-start">
            <div>
               <div class="font-bold text-xl text-gray-800">${pedido.clienteNome}</div>
               <div class="text-sm text-gray-500 flex items-center gap-1"><span class="material-icons text-xs">phone</span> ${pedido.clienteTel}</div>
            </div>
            <div class="text-right">
               <div class="text-xs font-bold bg-green-100 text-green-800 px-2 py-1 rounded uppercase">${pedido.pagamento}</div>
               <div class="text-xs text-gray-400 mt-1">${pedido.bairro}</div>
            </div>
         </div>
      `;

      // Obs
      const obsContainer = document.getElementById('modal-obs-geral-container');
      if (pedido.obs && pedido.obs !== 'undefined') {
        obsContainer.classList.remove('hidden');
        document.getElementById('modal-obs-geral').textContent = pedido.obs;
      } else {
        obsContainer.classList.add('hidden');
      }

      // Itens
      const lista = document.getElementById('modal-itens');
      lista.innerHTML = '';
      if (pedido.itens && Array.isArray(pedido.itens)) {
        pedido.itens.forEach(i => {
           let adds = i.adicionais ? i.adicionais.map(a=>`<div class="text-xs text-gray-500 ml-10 flex items-center gap-1"><span class="text-gray-300">‚Ä¢</span> ${a.nome}</div>`).join('') : '';
           let obsI = i.obs ? `<div class="text-xs text-red-500 ml-10 font-bold mt-0.5">‚ö†Ô∏è ${i.obs}</div>` : '';
           
           lista.innerHTML += `
              <div class="py-2 border-b border-gray-100 last:border-0">
                 <div class="flex gap-3 items-start">
                    <span class="bg-gray-900 text-white font-bold min-w-[24px] h-6 rounded flex items-center justify-center text-xs mt-0.5 shadow-sm">${i.qtde}</span>
                    <span class="font-bold text-gray-800 text-sm leading-snug">${i.nome}</span>
                 </div>
                 ${adds} ${obsI}
              </div>`;
        });
      }

      renderActionButtons(pedido.status);
      
      // Hist√≥rico (Load Lazy)
      document.getElementById('modal-history').innerHTML = '';
      document.getElementById('modal-history').classList.add('hidden');
      loadHistory(pedido.id); // Carrega em background

      document.getElementById('modal').classList.remove('hidden');
    }

    function toggleHistory() {
       document.getElementById('modal-history').classList.toggle('hidden');
    }

    function loadHistory(id) {
       google.script.run.withSuccessHandler(logs => {
          const div = document.getElementById('modal-history');
          if(!logs.length) { div.innerHTML='<span class="text-gray-400 italic p-2 block">Sem registros.</span>'; return; }
          div.innerHTML = logs.map(l => `
             <div class="flex justify-between text-xs border-l-2 border-gray-300 pl-2 py-1">
                <div class="flex flex-col">
                   <span class="font-bold text-gray-700">${l.status}</span>
                   <span class="text-gray-400 text-[10px]">por ${l.usuario.split(' ')[0]}</span>
                </div>
                <span class="text-gray-400 font-mono">${l.dataHora.split(' ')[2]}</span>
             </div>`).join('');
       }).getHistoricoPedido(id);
    }

    // --- BOT√ïES DE A√á√ÉO ---
    function renderActionButtons(status) {
      const div = document.getElementById('status-actions');
      div.innerHTML = '';
      
      // Configura√ß√£o dos Bot√µes (DCU: Cores sem√¢nticas e √çcones Claros)
      const steps = [
        {id:'PREPARANDO', icon:'skillet', lbl:'Preparar', color:'bg-yellow-500 hover:bg-yellow-600', text:'text-white'},
        {id:'EMBALAGEM', icon:'inventory_2', lbl:'Embalar', color:'bg-blue-500 hover:bg-blue-600', text:'text-white'},
        {id:'PRONTO_ENTREGA', icon:'check_circle', lbl:'Pronto', color:'bg-green-500 hover:bg-green-600', text:'text-white'},
        {id:'SAIU_ENTREGA', icon:'two_wheeler', lbl:'Saiu', color:'bg-purple-600 hover:bg-purple-700', text:'text-white'},
        {id:'ENTREGUE', icon:'done_all', lbl:'Finalizar', color:'bg-gray-700 hover:bg-gray-800', text:'text-white'}
      ];

      steps.forEach(s => {
         const active = status === s.id;
         const btn = document.createElement('button');
         // Estiliza√ß√£o Mobile First
         btn.className = `flex flex-col items-center justify-center p-2 rounded-lg transition-all transform active:scale-95 shadow-sm ${s.color} ${s.text} ${active ? 'opacity-40 ring-2 ring-offset-2 ring-gray-300 cursor-not-allowed' : ''}`;
         btn.disabled = active;
         btn.onclick = () => s.id === 'SAIU_ENTREGA' ? selMoto(s.id, btn) : changeSt(s.id, btn);
         
         btn.innerHTML = `
            <span class="material-icons text-2xl mb-1">${s.icon}</span>
            <span class="text-[10px] font-bold uppercase tracking-wide">${s.lbl}</span>
         `;
         div.appendChild(btn);
      });
      
      // Bot√£o Cancelar (Separado para seguran√ßa)
      const old = document.getElementById('btn-cancel'); if(old) old.remove();
      if(status!=='CANCELADO' && status!=='ENTREGUE') {
         const c = document.createElement('div'); // Container
         c.id = 'btn-cancel';
         c.className = "col-span-5 mt-3 pt-3 border-t border-gray-100 flex justify-center";
         c.innerHTML = `<button onclick="confirmCancel()" class="text-red-500 text-xs font-bold hover:text-red-700 flex items-center gap-1 px-3 py-1 rounded hover:bg-red-50 transition"><span class="material-icons text-sm">cancel</span> Cancelar Pedido</button>`;
         div.parentNode.appendChild(c);
      }
    }

    function confirmCancel() { if(confirm('üö® ATEN√á√ÉO:\nDeseja realmente CANCELAR e ESTORNAR o estoque?')) changeSt('CANCELADO', null); }
    function closeModal() { document.getElementById('modal').classList.add('hidden'); }
    function abrirFiltro() { document.getElementById('modal-filtro').classList.remove('hidden'); }
    
    function selMoto(st, btn) {
       btn.innerHTML = '<span class="material-icons animate-spin text-white">refresh</span>';
       google.script.run.withSuccessHandler(m => {
          // Restaura √≠cone
          btn.innerHTML = `<span class="material-icons text-2xl mb-1">two_wheeler</span><span class="text-[10px] font-bold uppercase">Saiu</span>`;
          
          if(!m.length) { if(confirm('Sem motoqueiros cadastrados. Seguir sem vincular?')) changeSt(st, btn, null); return; }
          
          // Prompt simplificado (Pode evoluir para um modal pr√≥prio no futuro)
          let txt = "üõµ SELECIONE O ENTREGADOR:\n\n";
          m.forEach((x,i)=> txt+= `[ ${i+1} ] ${x.nome}\n`);
          const r = prompt(txt + "\nDigite o N√öMERO correspondente:");
          
          if(r) {
             const idx = parseInt(r)-1;
             if(m[idx]) changeSt(st, btn, m[idx].id);
             else alert('Op√ß√£o inv√°lida.');
          }
       }).getMotoqueirosAdmin();
    }

    function changeSt(st, btn, motoId=null) {
       if(!pedidoAtual || !currentUser) return;
       
       // Feedback visual no bot√£o clicado
       if(btn) btn.innerHTML = '<span class="material-icons animate-spin text-xl">refresh</span>';
       
       // Bloqueia outros
       const all = document.querySelectorAll('#status-actions button');
       all.forEach(b => b.disabled = true);

       google.script.run.withSuccessHandler(r => {
          pedidoAtual.status = st;
          closeModal();
          if(r.linkNotificacao) window.open(r.linkNotificacao, '_blank');
          loadPedidos();
       }).atualizarStatusPedido(pedidoAtual.id, st, motoId, currentUser);
    }

    // --- FUN√á√ÉO DE IMPRESS√ÉO T√âRMICA (Mantida V3) ---
    function imprimirCupom() {
       if(!pedidoAtual) return;
       const p = pedidoAtual;
       const area = document.getElementById('printable-area');
       const dataPedido = p.dataHoraFormatada || new Date().toLocaleString('pt-BR');
       const fmt = (v) => parseFloat(v).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});

       const totalFinal = parseFloat(String(p.total).replace(',', '.'));
       const taxa = parseFloat(String(p.taxa).replace(',', '.') || 0);
       const subtotal = totalFinal - taxa;

       let itensHtml = '';
       if (p.itens && Array.isArray(p.itens)) {
          itensHtml += `<div style="display:flex; border-bottom:2px solid #000; font-weight:bold; font-size:10px; margin-bottom:5px; padding-bottom:2px;"><div style="width:10%">QTD</div><div style="width:50%">ITEM</div><div style="width:20%; text-align:right;">UN</div><div style="width:20%; text-align:right;">TOT</div></div>`;
          p.itens.forEach(i => {
             const unit = parseFloat(i.precoBase || i.preco || 0);
             let totalItem = unit * i.qtde;
             let addsHtml = '';
             if(i.adicionais && i.adicionais.length > 0) {
                i.adicionais.forEach(a => {
                   const vAdd = parseFloat(a.preco);
                   totalItem += (vAdd * i.qtde); 
                   addsHtml += `<div>+ ${a.nome} (${fmt(vAdd)})</div>`;
                });
             }
             const obsItem = i.obs ? `<div style="font-weight:bold;">‚ö†Ô∏è ${i.obs}</div>` : '';
             itensHtml += `<div class="dashed-line"><div class="item-row" style="font-size:11px;"><div style="font-weight:bold;">${i.qtde}</div><div style="font-weight:bold;">${i.nome}</div><div class="txt-right">${fmt(unit)}</div><div class="txt-right txt-bold">${fmt(totalItem)}</div></div><div style="font-size:9px; padding-left:10%; margin-top:2px;">${addsHtml} ${obsItem}</div></div>`;
          });
       }

       const obsGeral = (p.obs && p.obs !== 'undefined') ? `<div style="border:2px solid #000; padding:5px; font-weight:bold; margin:10px 0; text-align:center;">OBS: ${p.obs}</div>` : '';
       const refText = (p.referencia && p.referencia !== 'undefined') ? p.referencia : '-';

       area.innerHTML = `
          <div class="ticket-header"><div style="font-size:10px;">Data: ${dataPedido}</div><div class="txt-huge" style="margin:5px 0;">#${p.id.split('-')[1] || p.id}</div><div class="txt-big" style="border:1px solid #000; padding:2px; margin-top:5px;">${p.clienteNome.toUpperCase()}</div></div>
          <div class="ticket-body">${itensHtml}</div> ${obsGeral}
          <div class="print-totals"><div class="total-row"><span>Subtotal:</span> <span>R$ ${fmt(subtotal)}</span></div><div class="total-row"><span>Taxa Entrega:</span> <span>R$ ${fmt(taxa)}</span></div><div class="total-row txt-big" style="margin-top:5px; border-top:2px solid #000; padding-top:5px;"><span>TOTAL:</span> <span>R$ ${fmt(totalFinal)}</span></div><div class="total-row" style="margin-top:5px; font-size:11px;"><span>Pagamento:</span> <span style="font-weight:bold; border:1px solid #000; padding:0 4px;">${p.pagamento}</span></div></div>
          <div class="print-delivery"><div style="text-align:center; font-weight:bold; border-bottom:1px solid #000; margin-bottom:5px;">DADOS DE ENTREGA</div><div class="txt-big">${p.clienteNome}</div><div style="font-size:12px; margin-bottom:5px;">${p.clienteTel}</div><div style="font-size:12px;">${p.logradouro}, ${p.numero}</div><div style="font-size:12px;">${p.bairro}</div><div style="font-size:11px; margin-top:4px; font-weight:bold;">Ref: ${refText}</div></div>
          <div class="ticket-footer"><p style="font-weight:bold; margin-bottom:8px;">OBRIGADO PELA PREFER√äNCIA!</p><p style="font-size:9px; font-style:italic; line-height:1.4;">"A resili√™ncia √© a capacidade de transformar ventos contr√°rios em impulso para voar mais alto."<br><strong>Seja forte.</strong></p></div>
       `;
       window.print();
    }

    // Busca e Filtro JS
    function abrirFiltro() { document.getElementById('modal-filtro').classList.remove('hidden'); }
    function aplicarFiltros() {
       const f = {
          dataInicio: document.getElementById('f-dt-ini').value,
          dataFim: document.getElementById('f-dt-fim').value,
          termo: document.getElementById('f-termo').value,
          bairro: document.getElementById('f-bairro').value,
          produto: document.getElementById('f-prod').value,
          status: document.getElementById('f-status').value
       };
       clearInterval(autoRefresh);
       document.getElementById('last-update').textContent = 'Busca Ativa';
       document.getElementById('modal-filtro').classList.add('hidden');
       google.script.run.withSuccessHandler(d => { todosPedidos=d; renderCards(); }).buscarPedidosComFiltros(f);
    }
  </script>
</body>

</html>